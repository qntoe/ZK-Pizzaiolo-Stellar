<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PIZZA HERO: The Grand Restaurant üï∂Ô∏èüçï</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #050505; font-family: 'Orbitron', sans-serif; overflow: hidden; user-select: none; touch-action: none; }
        .pizza-font { font-family: 'Bangers', cursive; }
        .neon-text { text-shadow: 0 0 10px rgba(0, 255, 204, 0.8), 0 0 20px rgba(0, 255, 204, 0.4); }
        .neon-border { border: 2px solid #ff00ff; box-shadow: 0 0 15px rgba(255, 0, 255, 0.5); }
        #game-container canvas { border-radius: 15px; cursor: crosshair; }
        .phase-transition { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="flex flex-col items-center justify-center h-screen text-white">

    <!-- Overlays -->
    <div id="overlay" class="absolute inset-0 z-50 flex flex-col items-center justify-center text-center px-10 bg-black/90">
        <div id="overlay-content" class="phase-transition">
            <div class="text-9xl mb-4">üï∂Ô∏è</div>
            <h1 class="pizza-font text-8xl text-yellow-500 tracking-widest drop-shadow-[0_0_20px_#f59e0b]">PIZZA HERO</h1>
            <h2 class="text-blue-400 font-bold tracking-[0.2em] mb-8 uppercase text-sm">Consigliere's Masterplan</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mb-10 text-left">
                <div class="bg-blue-900/20 p-4 rounded-xl border border-blue-500/30">
                    <span class="text-blue-400 font-black block mb-2 underline text-xs">PHASE 1: THE KITCHEN</span>
                    <p class="text-[10px] text-gray-400 leading-tight">60 segundos de ritmo. Usa <span class="text-white font-bold">A S K L</span>. Cada barra llena = +1 Pizza.</p>
                </div>
                <div class="bg-purple-900/20 p-4 rounded-xl border border-purple-500/30">
                    <span class="text-purple-400 font-black block mb-2 underline text-xs">PHASE 2: THE TABLES</span>
                    <p class="text-[10px] text-gray-400 leading-tight">Usa el mouse o dedo: <span class="text-white font-bold">Haz CLICK y ARRASTRA</span> hacia las mesas para lanzar la pizza.</p>
                </div>
            </div>

            <button onclick="startPhase1()" class="bg-yellow-500 hover:bg-white hover:text-yellow-600 text-black font-black px-16 py-5 rounded-full text-2xl transition-all transform hover:scale-110 shadow-[0_0_30px_#f59e0b]">
                ENTER THE RESTAURANT
            </button>
        </div>
    </div>

    <!-- HUD -->
    <div id="hud" class="hidden absolute top-6 w-[800px] flex justify-between items-end px-4 z-10 pointer-events-none">
        <div class="flex flex-col">
            <span id="phase-label" class="text-blue-400 font-black text-[10px] tracking-widest uppercase mb-1">Phase 1: Kitchen</span>
            <div class="bg-gray-900/80 px-6 py-2 rounded-lg border-2 border-blue-500">
                <span id="score-val" class="pizza-font text-4xl text-white">0</span>
            </div>
        </div>
        
        <div class="flex flex-col items-center">
            <span id="timer-label" class="text-red-500 font-black text-[10px] tracking-widest uppercase mb-1">Time Remaining</span>
            <div class="bg-gray-900/80 px-8 py-2 rounded-full border-2 border-red-500">
                <span id="timer-val" class="pizza-font text-5xl text-white">60s</span>
            </div>
        </div>

        <div class="flex flex-col items-end">
            <span id="extra-label" class="text-yellow-500 font-black text-[10px] tracking-widest uppercase mb-1">Pizzas Ready</span>
            <div class="bg-gray-900/80 px-6 py-2 rounded-lg border-2 border-yellow-500">
                <span id="extra-val" class="pizza-font text-4xl text-white">0</span>
            </div>
        </div>
    </div>

    <!-- Game Container -->
    <div id="game-container" class="neon-border bg-black"></div>

    <!-- Progress Bar (Phase 1 only) -->
    <div id="p1-progress" class="hidden mt-6 w-[800px] flex flex-col items-center">
        <div class="flex justify-between w-full text-[10px] font-black text-blue-400 mb-1">
            <span>DOUGH PREPARATION</span>
            <span id="p1-pct">0%</span>
        </div>
        <div class="w-full h-4 bg-gray-900 rounded-full border border-blue-500/30 p-1">
            <div id="p1-bar" class="h-full bg-blue-500 rounded-full shadow-[0_0_15px_#3b82f6]" style="width: 0%"></div>
        </div>
    </div>

    <script>
        // --- Global State ---
        let score = 0;
        let pizzasCreated = 0;
        let pizzasDelivered = 0;
        let timeLeft = 60;
        let currentPhase = 0;
        let doughProgress = 0;

        // --- Audio Engine ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(freq, type, dur, vol=0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            g.gain.setValueAtTime(vol, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }

        // --- Phaser Config ---
        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            width: 800,
            height: 600,
            backgroundColor: '#0a0a0a',
            physics: { default: 'arcade', arcade: { debug: false } },
            scene: { preload, create, update }
        };

        const game = new Phaser.Game(config);
        let sceneInstance;

        // Phase 1 Objects
        const LANES = [200, 333, 466, 600];
        const KEYS = ['A', 'S', 'K', 'L'];
        const COLORS = [0xff4757, 0x2ed573, 0xffa502, 0x5352ed];
        const EMOJIS = ['üçï', 'üçÑ', 'üçç', 'üå∂Ô∏è'];
        let p1Notes;

        // Phase 2 Objects
        let tables, deliveredPizzas, trajectoryLine, activePizza;
        let dragStartX, dragStartY;

        function preload() {}

        function create() {
            sceneInstance = this;
            this.input.keyboard.on('keydown', (e) => {
                if(currentPhase === 1) {
                    const idx = KEYS.indexOf(e.key.toUpperCase());
                    if(idx !== -1) checkP1Hit(idx);
                }
            });

            this.input.on('pointerdown', startToss);
            this.input.on('pointerup', endToss);
            this.input.on('pointermove', updateToss);
            
            trajectoryLine = this.add.graphics();
        }

        function update() {
            if(currentPhase === 1) {
                p1Notes.children.iterate(n => {
                    if(n && n.y > 650) { n.destroy(); doughProgress = Math.max(0, doughProgress - 5); updateUI(); }
                });
            }
        }

        // --- Phase 1 Logic ---
        function startPhase1() {
            currentPhase = 1;
            timeLeft = 60;
            score = 0;
            pizzasCreated = 0;
            doughProgress = 0;
            
            document.getElementById('overlay').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
            document.getElementById('p1-progress').classList.remove('hidden');
            
            document.getElementById('phase-label').innerText = "Phase 1: Kitchen";
            document.getElementById('extra-label').innerText = "Pizzas Ready";
            
            setupP1Scene();
            startTimer();
            updateUI();
        }

        function setupP1Scene() {
            const self = sceneInstance;
            self.children.removeAll();
            self.add.rectangle(400, 300, 800, 600, 0x050505);
            
            const g = self.add.graphics();
            LANES.forEach((x, i) => {
                g.lineStyle(2, 0x1a1a1a);
                g.lineBetween(x, 0, x, 600);
                self.add.circle(x, 520, 35, 0x000000).setStrokeStyle(3, COLORS[i]);
            });

            p1Notes = self.physics.add.group();
            self.p1SpawnEvent = self.time.addEvent({ delay: 600, callback: spawnP1Note, loop: true });
        }

        function spawnP1Note() {
            const lane = Phaser.Math.Between(0, 3);
            const n = sceneInstance.add.container(LANES[lane], -50);
            const c = sceneInstance.add.circle(0,0, 30, COLORS[lane]).setStrokeStyle(3, 0xffffff);
            const t = sceneInstance.add.text(-15, -15, EMOJIS[lane], { fontSize: '30px' });
            n.add([c, t]);
            p1Notes.add(n);
            sceneInstance.physics.add.existing(n);
            n.body.setVelocityY(450);
            n.setData('lane', lane);
        }

        function checkP1Hit(lane) {
            let hit = false;
            p1Notes.children.iterate(n => {
                if(!n || n.getData('lane') !== lane) return;
                const dist = Math.abs(n.y - 520);
                if(dist < 80) { hit = true; n.destroy(); processP1Hit(dist); }
            });
            if(!hit) playSfx(100, 'sawtooth', 0.1, 0.05);
        }

        function processP1Hit(dist) {
            let p = dist < 25 ? 30 : (dist < 50 ? 15 : 10);
            score += p * 10;
            doughProgress += p;
            if(doughProgress >= 100) {
                doughProgress = 0;
                pizzasCreated++;
                playSfx(1200, 'sine', 0.3, 0.1);
            }
            updateUI();
        }

        // --- Phase 2 Logic ---
        function transitionToPhase2() {
            currentPhase = 2;
            sceneInstance.p1SpawnEvent.remove();
            p1Notes.clear(true, true);
            
            const overlay = document.getElementById('overlay');
            const content = document.getElementById('overlay-content');
            overlay.classList.remove('hidden');
            content.innerHTML = `
                <h1 class="pizza-font text-6xl text-yellow-500 mb-4">PRODUCTION ENDED!</h1>
                <div class="bg-blue-600/20 p-8 rounded-3xl border-4 border-white mb-8">
                    <div class="text-9xl mb-4">üçï</div>
                    <span class="text-6xl pizza-font">x${pizzasCreated}</span>
                    <p class="text-blue-400 font-bold tracking-widest uppercase text-xs">Pizzas Ready for Delivery</p>
                </div>
                <button onclick="startPhase2()" class="bg-purple-600 hover:bg-white hover:text-purple-600 text-white font-black px-12 py-4 rounded-full text-2xl shadow-[0_0_30px_#a855f7]">
                    START DELIVERY
                </button>
            `;
        }

        function startPhase2() {
            document.getElementById('overlay').classList.add('hidden');
            document.getElementById('p1-progress').classList.add('hidden');
            document.getElementById('phase-label').innerText = "Phase 2: Delivery";
            document.getElementById('extra-label').innerText = "Inventory";
            
            setupP2Scene();
            timeLeft = 60;
            startTimer();
            updateUI();
        }

        function setupP2Scene() {
            const self = sceneInstance;
            self.children.removeAll();
            self.add.rectangle(400, 300, 800, 600, 0x1a110a);
            self.add.grid(400, 300, 800, 600, 50, 50, 0, 0, 0x2d1b0d);
            
            tables = self.physics.add.group();
            deliveredPizzas = self.physics.add.group();
            
            for(let i=0; i<6; i++) spawnTable();

            self.add.rectangle(400, 580, 800, 40, 0x3d2b1f).setStrokeStyle(2, 0xff00ff);
            self.add.text(360, 575, "THE COUNTER", { fontFamily: 'Orbitron', fontSize: '10px', color: '#ff00ff' });

            self.physics.add.overlap(deliveredPizzas, tables, handleDelivery, null, self);
            trajectoryLine = self.add.graphics();
        }

        function spawnTable() {
            const x = Phaser.Math.Between(100, 700);
            const y = Phaser.Math.Between(80, 450);
            const table = sceneInstance.add.container(x, y);
            const wood = sceneInstance.add.circle(0, 0, 40, 0x5d4037).setStrokeStyle(4, 0xffffff);
            const icon = sceneInstance.add.text(-15, -15, "üë§", { fontSize: '30px' });
            const happy = sceneInstance.add.text(-15, -50, "üòã", { fontSize: '30px' }).setAlpha(0);
            
            table.add([wood, icon, happy]);
            table.setData('isServed', false);
            tables.add(table);
            sceneInstance.physics.add.existing(table);
            table.body.setCircle(40, -40, -40);
        }

        function startToss(pointer) {
            if(currentPhase !== 2 || pizzasCreated <= 0) return;
            dragStartX = pointer.x;
            dragStartY = pointer.y;
            activePizza = sceneInstance.add.container(400, 550);
            const c = sceneInstance.add.circle(0, 0, 25, 0xffcc00).setStrokeStyle(3, 0xffffff);
            const t = sceneInstance.add.text(-15, -15, "üçï", { fontSize: '30px' });
            activePizza.add([c, t]);
            activePizza.setDepth(100);
        }

        function updateToss(pointer) {
            if(!activePizza) return;
            trajectoryLine.clear();
            trajectoryLine.lineStyle(3, 0x00ffcc, 0.5);
            trajectoryLine.beginPath();
            trajectoryLine.moveTo(400, 550);
            const dx = pointer.x - dragStartX;
            const dy = pointer.y - dragStartY;
            trajectoryLine.lineTo(400 + dx, 550 + dy);
            trajectoryLine.strokePath();
        }

        function endToss(pointer) {
            if(!activePizza) return;
            trajectoryLine.clear();
            const dx = pointer.x - dragStartX;
            const dy = pointer.y - dragStartY;
            if(Math.abs(dx) < 10 && Math.abs(dy) < 10) { activePizza.destroy(); activePizza = null; return; }

            pizzasCreated--;
            updateUI();
            
            sceneInstance.physics.add.existing(activePizza);
            const power = 3.5;
            activePizza.body.setVelocity(dx * power, dy * power);
            activePizza.body.setDrag(50);
            activePizza.body.setCircle(25, -25, -25);
            deliveredPizzas.add(activePizza);
            
            sceneInstance.tweens.add({ targets: activePizza, scale: 2, yoyo: true, duration: 400 });
            playSfx(600, 'sine', 0.2, 0.1);
            activePizza = null;
        }

        function handleDelivery(pizza, table) {
            if(table.getData('isServed')) return;
            pizza.destroy();
            table.setData('isServed', true);
            table.body.setEnable(false);

            pizzasDelivered++;
            score += 1000;
            playSfx(880, 'sine', 0.3, 0.1);
            sceneInstance.cameras.main.shake(100, 0.005);
            updateUI();

            const wood = table.list[0];
            const happy = table.list[2];
            wood.setStrokeStyle(6, 0x22c55e);
            happy.setAlpha(1);

            const p = sceneInstance.add.text(table.x - 15, table.y - 15, "üçï", { fontSize: '30px' });
            
            sceneInstance.tweens.add({
                targets: [table, p],
                x: -150,
                duration: 2500,
                ease: 'Power2',
                onComplete: () => { table.destroy(); p.destroy(); if(currentPhase === 2) spawnTable(); }
            });

            sceneInstance.tweens.add({ targets: [table, p], y: table.y - 40, duration: 200, yoyo: true, repeat: 1 });
        }

        function startTimer() {
            if(this.globalTimer) clearInterval(this.globalTimer);
            this.globalTimer = setInterval(() => {
                if(currentPhase === 0) return;
                timeLeft--;
                document.getElementById('timer-val').innerText = timeLeft + 's';
                if(timeLeft <= 0) {
                    clearInterval(this.globalTimer);
                    if(currentPhase === 1) transitionToPhase2();
                    else finalizeGame();
                }
            }, 1000);
        }

        function updateUI() {
            document.getElementById('score-val').innerText = score;
            document.getElementById('timer-val').innerText = timeLeft + 's';
            document.getElementById('extra-val').innerText = pizzasCreated;
            if(currentPhase === 1) {
                document.getElementById('p1-bar').style.width = doughProgress + '%';
                document.getElementById('p1-pct').innerText = Math.floor(doughProgress) + '%';
            }
        }

        function finalizeGame() {
            currentPhase = 0;
            const overlay = document.getElementById('overlay');
            const content = document.getElementById('overlay-content');
            overlay.classList.remove('hidden');
            content.innerHTML = `
                <div class="text-9xl mb-4">üíé</div>
                <h1 class="pizza-font text-7xl text-yellow-500 mb-2">SHIFT COMPLETE!</h1>
                <div class="grid grid-cols-2 gap-4 max-w-sm mx-auto my-8 text-left bg-gray-900/80 p-6 rounded-2xl border-2 border-blue-500">
                    <div class="text-gray-400 text-xs uppercase">Delivered:</div><div class="font-bold text-blue-400 text-xl">${pizzasDelivered}</div>
                    <div class="text-gray-400 text-xs uppercase">Kitchen Score:</div><div class="font-bold text-gray-200 text-xl">${score - (pizzasDelivered*1000)}</div>
                    <div class="col-span-2 h-px bg-gray-700 my-2"></div>
                    <div class="text-yellow-500 font-black text-xl uppercase">FINAL SCORE:</div><div class="font-black text-3xl text-white">${score}</div>
                </div>
                <div class="flex gap-4 justify-center">
                    <button onclick="location.reload()" class="bg-gray-700 hover:bg-white hover:text-black text-white font-black px-10 py-4 rounded-full transition-all">RETRY</button>
                    <button onclick="submitZKProof()" class="bg-blue-600 hover:bg-white hover:text-blue-600 text-white font-black px-10 py-4 rounded-full transition-all shadow-[0_0_20px_#2563eb]">SUBMIT ZK</button>
                </div>
            `;
        }

        function submitZKProof() {
            alert(`üï∂Ô∏è CONSIGLIERE SLICE:\n\nProof Generated.\nKitchen Performance: OK\nPhysics Delivery: OK\nStellar: UPDATED`);
            location.reload();
        }
    </script>
</body>
</html>
