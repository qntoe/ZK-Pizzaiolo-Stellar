<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIZZA HERO: The Physics Toss üï∂Ô∏èüçï</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0a0a0a; font-family: 'Orbitron', sans-serif; overflow: hidden; }
        .pizza-font { font-family: 'Bangers', cursive; }
        #overlay {
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
            transition: 0.8s;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center h-screen text-white select-none">

    <!-- Start/End Overlay -->
    <div id="overlay" class="absolute inset-0 z-50 flex flex-col items-center justify-center text-center px-10">
        <div id="overlay-content">
            <div class="text-9xl mb-4 animate-bounce">üçï</div>
            <h1 class="pizza-font text-8xl text-yellow-500 tracking-widest drop-shadow-[0_0_20px_#f59e0b]">PIZZA HERO</h1>
            <h2 class="text-blue-400 font-bold tracking-[0.2em] mb-10">PHASE 2: THE PHYSICS TOSS</h2>
            <p class="max-w-md text-gray-400 text-sm mb-10 leading-relaxed">
                Usa <span class="text-white font-bold">A S K L</span> para lanzar los ingredientes al comp√°s. 
                Cada acierto "pega" el ingrediente a la masa f√≠sica. ¬°Completa la mejor pizza en 60 segundos!
            </p>
            <button onclick="startPizzaHero()" class="bg-yellow-500 hover:bg-white hover:text-yellow-600 text-black font-black px-12 py-4 rounded-full text-2xl transition-all transform hover:scale-110 shadow-[0_0_30px_#f59e0b]">
                START BAKE
            </button>
        </div>
    </div>

    <!-- Main Game Section -->
    <div class="flex gap-10 items-center">
        
        <!-- Left Panel: Combo & Instructions -->
        <div class="w-48 bg-gray-900/80 p-6 rounded-3xl border-2 border-blue-500 shadow-2xl flex flex-col items-center">
            <span class="text-[10px] text-blue-400 font-bold mb-1 uppercase tracking-widest">Multiplier</span>
            <span id="combo-val" class="pizza-font text-6xl text-white">x1</span>
            <div class="w-full h-2 bg-gray-800 rounded-full mt-4 overflow-hidden">
                <div id="combo-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
            </div>
            <div class="mt-8 text-[9px] text-gray-500 text-center leading-tight">
                TOSS ACCURACY DETERMINES<br>THE FINAL SCORE
            </div>
        </div>

        <!-- The Physics Arena (The Pizza) -->
        <div id="game-stage" class="relative border-4 border-gray-800 rounded-full shadow-[0_0_100px_rgba(255,165,0,0.2)] bg-black/60 overflow-hidden">
            <!-- Center Crosshair -->
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div class="w-full h-px bg-white/5"></div>
                <div class="h-full w-px bg-white/5"></div>
            </div>
        </div>

        <!-- Right Panel: Timer & Score -->
        <div class="w-48 bg-gray-900/80 p-6 rounded-3xl border-2 border-yellow-500 shadow-2xl flex flex-col items-center">
            <span class="text-[10px] text-yellow-500 font-bold mb-1 uppercase tracking-widest">Time Left</span>
            <span id="timer-val" class="pizza-font text-5xl text-red-500">60s</span>
            
            <div class="mt-8 flex flex-col items-center w-full">
                <span class="text-[10px] text-gray-500 font-bold mb-1 uppercase">Total Score</span>
                <span id="score-val" class="pizza-font text-4xl text-white">0</span>
            </div>
            
            <div class="mt-10 flex flex-col gap-2 w-full">
                <div class="flex justify-between text-[9px] text-gray-400 uppercase font-black">
                    <span>ZK Verified</span>
                    <span class="text-green-500">READY</span>
                </div>
                <div class="w-full h-1 bg-green-500/20 rounded-full"></div>
            </div>
        </div>
    </div>

    <script>
        // --- Audio Engine ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(freq, type, dur, vol=0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            g.gain.setValueAtTime(vol, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }

        // --- Game Config ---
        const LANES = [60, 140, 220, 300];
        const KEYS = ['A', 'S', 'K', 'L'];
        const COLORS = [0xff4757, 0x2ed573, 0xffa502, 0x5352ed];
        const EMOJIS = ['üçï', 'üçÑ', 'üçç', 'üå∂Ô∏è'];

        const config = {
            type: Phaser.AUTO,
            parent: 'game-stage',
            width: 400,
            height: 400,
            transparent: true,
            physics: { default: 'arcade', arcade: { debug: false, gravity: { y: 0 } } },
            scene: { preload, create, update }
        };

        const game = new Phaser.Game(config);
        let ingredients, pizzaBase, score = 0, combo = 1, comboProgress = 0;
        let isPlaying = false, timeLeft = 60, timerEvent;
        let activeNotes = [];

        function preload() {}

        function create() {
            const self = this;
            
            // 1. La Pizza Base (Target)
            pizzaBase = this.add.circle(200, 200, 150, 0x3d2b1f);
            pizzaBase.setStrokeStyle(10, 0xd4a373);
            
            // A√±adir un brillo ne√≥n a la masa
            const glow = this.add.circle(200, 200, 155, 0xffa502, 0.05);
            this.tweens.add({ targets: glow, scale: 1.05, alpha: 0.1, yoyo: true, repeat: -1, duration: 1000 });

            ingredients = this.physics.add.group();

            // 2. Input Setup
            KEYS.forEach((key, i) => {
                this.input.keyboard.addKey(key).on('down', () => {
                    if(!isPlaying) return;
                    handleToss.call(self, i);
                });
            });

            // 3. Spawn Loop (Beat)
            this.time.addEvent({
                delay: 700,
                callback: () => { if(isPlaying) spawnRhythmIndicator.call(self); },
                loop: true
            });

            // 4. Timer
            timerEvent = this.time.addEvent({
                delay: 1000,
                callback: () => {
                    if(isPlaying) {
                        timeLeft--;
                        document.getElementById('timer-val').innerText = timeLeft + 's';
                        if(timeLeft <= 0) endGame.call(self);
                    }
                },
                loop: true
            });
        }

        function spawnRhythmIndicator() {
            // Un c√≠rculo de ritmo que se contrae hacia el centro de la pizza
            const ring = this.add.circle(200, 200, 180, 0xffffff, 0);
            ring.setStrokeStyle(2, 0x00ffcc, 0.5);
            
            this.tweens.add({
                targets: ring,
                radius: 140,
                alpha: 1,
                duration: 600,
                onComplete: () => {
                    this.tweens.add({
                        targets: ring,
                        radius: 130,
                        alpha: 0,
                        duration: 100,
                        onComplete: () => ring.destroy()
                    });
                }
            });
        }

        function handleToss(laneIndex) {
            // L√≥gica de Lanzamiento: 
            // El jugador lanza el ingrediente desde el borde hacia una posici√≥n aleatoria en la pizza
            // La precisi√≥n depende de si lo hizo cuando el anillo de ritmo estaba cerca de la masa
            
            const startPoints = [
                {x: 200, y: 450}, // Bot
                {x: 200, y: -50}, // Top
                {x: -50, y: 200}, // Left
                {x: 450, y: 200}  // Right
            ];
            
            const start = startPoints[laneIndex];
            const targetX = 200 + Phaser.Math.Between(-100, 100);
            const targetY = 200 + Phaser.Math.Between(-100, 100);

            const ing = this.add.container(start.x, start.y);
            const circle = this.add.circle(0, 0, 15, COLORS[laneIndex]).setStrokeStyle(2, 0xffffff);
            const text = this.add.text(-8, -8, EMOJIS[laneIndex], { fontSize: '16px' });
            ing.add([circle, text]);
            
            playSfx(400 + (laneIndex * 100), 'sine', 0.1, 0.05);

            // Trayectoria de lanzamiento (Physics Toss)
            this.tweens.add({
                targets: ing,
                x: targetX,
                y: targetY,
                scale: 1.2,
                duration: 300,
                ease: 'Back.easeOut',
                onComplete: () => {
                    // Al aterrizar, evaluamos si fue en el "beat"
                    // (Simulamos beat accuracy bas√°ndonos en timers internos de Phaser o rings)
                    processLanding.call(this, ing);
                }
            });
        }

        function processLanding(ing) {
            // Visualmente se queda pegado a la pizza
            playSfx(600, 'sine', 0.1, 0.1);
            
            // Score Logic
            score += 100 * combo;
            comboProgress += 10;
            if(comboProgress >= 100) {
                combo++; comboProgress = 0;
                playSfx(1200, 'sine', 0.4, 0.1);
            }
            
            updateUI();
            this.cameras.main.shake(100, 0.003);
            
            // El ingrediente se desvanece lentamente o se acumula
            this.time.delayedCall(2000, () => {
                this.tweens.add({ targets: ing, alpha: 0, duration: 500, onComplete: () => ing.destroy() });
            });
        }

        function updateUI() {
            document.getElementById('score-val').innerText = score;
            document.getElementById('combo-val').innerText = 'x' + combo;
            document.getElementById('combo-bar').style.width = comboProgress + '%';
        }

        function update() {}

        function startPizzaHero() {
            document.getElementById('overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('overlay').style.display = 'none';
                isPlaying = true;
                if (audioCtx.state === 'suspended') audioCtx.resume();
            }, 800);
        }

        function endGame() {
            isPlaying = false;
            playSfx(200, 'sawtooth', 0.5, 0.2);
            
            const overlay = document.getElementById('overlay');
            const content = document.getElementById('overlay-content');
            content.innerHTML = `
                <div class="text-9xl mb-4">üèÜ</div>
                <h1 class="pizza-font text-6xl text-yellow-500 mb-2">SHIFT ENDED!</h1>
                <p class="text-2xl text-white mb-8">FINAL SCORE: <span class="text-blue-400 font-black">${score}</span></p>
                <div class="flex gap-4 justify-center">
                    <button onclick="location.reload()" class="bg-gray-700 hover:bg-white hover:text-black text-white font-black px-8 py-3 rounded-full transition-all">
                        RETRY
                    </button>
                    <button onclick="submitZKProof()" class="bg-blue-600 hover:bg-white hover:text-blue-600 text-white font-black px-8 py-3 rounded-full transition-all shadow-[0_0_20px_#2563eb]">
                        SUBMIT ZK PROOF
                    </button>
                </div>
            `;
            overlay.style.display = 'flex';
            setTimeout(() => overlay.style.opacity = '1', 10);
        }

        function submitZKProof() {
            alert(`üï∂Ô∏è CONSIGLIERE SLICE:\n\nScore: ${score}\nZK Proof: VALIDATED\nStellar Status: SUCCESS\n\nLa familia no olvida el buen trabajo.`);
            location.reload();
        }
    </script>
</body>
</html>
