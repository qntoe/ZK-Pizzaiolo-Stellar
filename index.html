<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIZZA HERO: Production & Delivery üï∂Ô∏èüçï</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #050505; font-family: 'Orbitron', sans-serif; overflow: hidden; }
        .pizza-font { font-family: 'Bangers', cursive; }
        #overlay { background: radial-gradient(circle, #1a1a1a 0%, #000 100%); transition: 0.8s; }
        .neon-border-blue { border: 2px solid #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        .neon-border-green { border: 2px solid #22c55e; box-shadow: 0 0 15px rgba(34, 197, 94, 0.5); }
    </style>
</head>
<body class="flex flex-col items-center justify-center h-screen text-white select-none">

    <!-- Start/End Overlay -->
    <div id="overlay" class="absolute inset-0 z-50 flex flex-col items-center justify-center text-center px-10">
        <div id="overlay-content">
            <div class="text-9xl mb-4 animate-bounce">üçï</div>
            <h1 class="pizza-font text-8xl text-yellow-500 tracking-widest drop-shadow-[0_0_20px_#f59e0b]">PIZZA HERO</h1>
            <h2 class="text-blue-400 font-bold tracking-[0.2em] mb-6">FASE 1: PREP | FASE 2: DELIVERY</h2>
            <div class="max-w-md bg-gray-900/80 p-6 rounded-2xl border border-gray-700 mb-8 text-sm text-gray-300 leading-relaxed">
                <p class="mb-2"><span class="text-yellow-500 font-bold">FASE 1:</span> Usa <span class="text-white font-bold">A S K L</span> para recolectar ingredientes y llenar la barra de masa. ¬°Cada barra llena es <span class="text-white font-bold">+1 Pizza</span>!</p>
                <p><span class="text-green-500 font-bold">FASE 2:</span> Pulsa <span class="text-white font-bold">ESPACIO</span> para lanzar tus pizzas preparadas a los clientes hambrientos.</p>
            </div>
            <button onclick="startPizzaHero()" class="bg-yellow-500 hover:bg-white hover:text-yellow-600 text-black font-black px-12 py-4 rounded-full text-2xl transition-all transform hover:scale-110 shadow-[0_0_30px_#f59e0b]">
                COMIENZA EL TURNO
            </button>
        </div>
    </div>

    <!-- Main Game UI -->
    <div class="flex gap-6 items-stretch h-[650px]">
        
        <!-- Left: Phase 1 (Production) -->
        <div class="w-64 bg-gray-900/80 p-4 rounded-3xl neon-border-blue flex flex-col">
            <div class="text-center mb-4">
                <span class="text-[10px] text-blue-400 font-black tracking-widest uppercase">Fase 1: Producci√≥n</span>
                <h3 class="pizza-font text-2xl">THE KITCHEN</h3>
            </div>
            
            <div id="phase1-container" class="flex-grow bg-black/40 rounded-xl relative overflow-hidden border border-gray-800">
                <!-- Lanes will be here -->
            </div>

            <div class="mt-4 space-y-2">
                <div class="flex justify-between text-[10px] font-bold">
                    <span>DOUGH PROGRESS</span>
                    <span id="dough-pct">0%</span>
                </div>
                <div class="w-full h-3 bg-gray-800 rounded-full overflow-hidden border border-blue-900">
                    <div id="dough-bar" class="h-full bg-blue-500 shadow-[0_0_10px_#3b82f6]" style="width: 0%"></div>
                </div>
                <div class="bg-blue-600/20 py-2 rounded-lg border border-blue-500/30 text-center">
                    <span class="text-xs font-bold text-blue-200">READY: </span>
                    <span id="pizza-ready-count" class="pizza-font text-xl text-white">0</span>
                </div>
            </div>
        </div>

        <!-- Center: Phase 2 (Delivery / The Street) -->
        <div class="w-[500px] bg-gray-900/80 p-4 rounded-3xl neon-border-green flex flex-col">
            <div class="text-center mb-4">
                <span class="text-[10px] text-green-400 font-black tracking-widest uppercase">Fase 2: Delivery</span>
                <h3 class="pizza-font text-2xl">THE STREET</h3>
            </div>
            
            <div id="phase2-container" class="flex-grow bg-black/40 rounded-xl relative overflow-hidden border border-gray-800">
                <!-- Delivery Arena -->
            </div>

            <div class="mt-4 flex justify-between items-center bg-green-600/10 p-3 rounded-xl border border-green-500/30">
                <div class="text-left">
                    <span class="text-[9px] text-gray-500 font-bold block uppercase">Action</span>
                    <span class="text-xs font-black text-green-400">[SPACE] TO TOSS</span>
                </div>
                <div class="text-right">
                    <span class="text-[9px] text-gray-500 font-bold block uppercase">Delivered</span>
                    <span id="delivered-count" class="pizza-font text-2xl text-white">0</span>
                </div>
            </div>
        </div>

        <!-- Right: Stats -->
        <div class="w-40 flex flex-col gap-4">
            <div class="bg-gray-900/80 p-6 rounded-3xl border-2 border-red-500 shadow-xl text-center">
                <span class="text-[10px] text-red-400 font-bold block mb-1">TIME</span>
                <span id="timer-val" class="pizza-font text-5xl text-white">60s</span>
            </div>
            <div class="bg-gray-900/80 p-6 rounded-3xl border-2 border-yellow-500 shadow-xl text-center flex-grow">
                <span class="text-[10px] text-yellow-500 font-bold block mb-1 uppercase">Total Score</span>
                <span id="score-val" class="pizza-font text-4xl text-white">0</span>
                <div class="mt-6 space-y-4">
                    <div class="text-[9px] text-gray-500">
                        <div class="flex justify-between mb-1"><span>ZK PROOF</span><span class="text-green-500">ACTIVE</span></div>
                        <div class="w-full h-0.5 bg-gray-800"><div class="h-full bg-green-500 w-full animate-pulse"></div></div>
                    </div>
                    <div class="text-[9px] text-gray-500">
                        <div class="flex justify-between mb-1"><span>STELLAR</span><span class="text-blue-500">SYNC</span></div>
                        <div class="w-full h-0.5 bg-gray-800"><div class="h-full bg-blue-500 w-full"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let doughProgress = 0;
        let pizzasReady = 0;
        let deliveredCount = 0;
        let score = 0;
        let timeLeft = 60;
        let isPlaying = false;

        // --- Audio ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(freq, type, dur, vol=0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            g.gain.setValueAtTime(vol, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }

        // --- Phaser Phase 1: Production ---
        const p1Config = {
            type: Phaser.AUTO,
            parent: 'phase1-container',
            width: 256,
            height: 480,
            backgroundColor: '#0a0a0a',
            physics: { default: 'arcade' },
            scene: { preload: p1Preload, create: p1Create, update: p1Update }
        };

        const LANES = [40, 100, 160, 220];
        const KEYS = ['A', 'S', 'K', 'L'];
        const COLORS = [0xff4757, 0x2ed573, 0xffa502, 0x5352ed];
        const EMOJIS = ['üçï', 'üçÑ', 'üçç', 'üå∂Ô∏è'];
        let p1Notes;

        function p1Preload() {}
        function p1Create() {
            const self = this;
            const g = this.add.graphics();
            LANES.forEach((x, i) => {
                g.lineStyle(1, 0x1a1a1a);
                g.lineBetween(x, 0, x, 480);
                this.add.circle(x, 420, 20, 0x000000).setStrokeStyle(2, COLORS[i]);
                this.input.keyboard.addKey(KEYS[i]).on('down', () => {
                    if(!isPlaying) return;
                    checkP1Hit.call(self, i);
                });
            });
            p1Notes = this.physics.add.group();
            this.time.addEvent({ delay: 600, callback: () => { if(isPlaying) spawnP1Note.call(self); }, loop: true });
        }
        function spawnP1Note() {
            const lane = Phaser.Math.Between(0, 3);
            const n = this.add.container(LANES[lane], -30);
            n.add([this.add.circle(0, 0, 18, COLORS[lane]).setStrokeStyle(2, 0xffffff), this.add.text(-10, -10, EMOJIS[lane], {fontSize: '18px'})]);
            p1Notes.add(n);
            this.physics.add.existing(n);
            n.body.setVelocityY(350);
            n.setData('lane', lane);
        }
        function checkP1Hit(lane) {
            let hit = false;
            p1Notes.children.iterate(n => {
                if(!n || n.getData('lane') !== lane) return;
                const dist = Math.abs(n.y - 420);
                if(dist < 50) { hit = true; n.destroy(); addDough(dist); }
            });
            if(!hit) playSfx(100, 'sawtooth', 0.1, 0.05);
        }
        function p1Update() {
            if(!isPlaying) return;
            p1Notes.children.iterate(n => { if(n && n.y > 500) n.destroy(); });
        }

        // --- Phaser Phase 2: Delivery ---
        const p2Config = {
            type: Phaser.AUTO,
            parent: 'phase2-container',
            width: 500,
            height: 480,
            backgroundColor: '#0f0f0f',
            physics: { default: 'arcade' },
            scene: { create: p2Create, update: p2Update }
        };

        let customers, flyingPizzas;
        function p2Create() {
            const self = this;
            // Draw counter/street
            this.add.rectangle(450, 240, 100, 480, 0x1a1a1a); // Door
            customers = this.physics.add.group();
            flyingPizzas = this.physics.add.group();
            
            this.time.addEvent({ delay: 2500, callback: () => { if(isPlaying) spawnCustomer.call(self); }, loop: true });
            
            this.input.keyboard.addKey('SPACE').on('down', () => { if(isPlaying) tossPizza.call(self); });
            
            this.physics.add.overlap(flyingPizzas, customers, deliverSuccess, null, this);
        }
        function spawnCustomer() {
            const y = Phaser.Math.Between(50, 430);
            const c = this.add.container(550, y);
            c.add([this.add.circle(0,0, 25, 0xef4444).setStrokeStyle(2, 0xffffff), this.add.text(-12, -12, 'üë§', {fontSize: '24px'})]);
            customers.add(c);
            this.physics.add.existing(c);
            c.body.setVelocityX(-80 - (deliveredCount * 2));
        }
        function tossPizza() {
            if(pizzasReady <= 0) { playSfx(150, 'sawtooth', 0.1, 0.1); return; }
            pizzasReady--;
            updateUI();
            playSfx(400, 'sine', 0.1, 0.1);
            
            const p = this.add.text(50, 240, 'üçï', {fontSize: '32px'});
            flyingPizzas.add(p);
            this.physics.add.existing(p);
            // Target the closest customer
            let target = null;
            let minDist = 1000;
            customers.children.iterate(c => {
                if(c.x < minDist) { minDist = c.x; target = c; }
            });
            
            if(target) {
                this.physics.moveToObject(p, target, 400);
            } else {
                p.body.setVelocityX(400);
            }
        }
        function deliverSuccess(pizza, customer) {
            pizza.destroy();
            customer.destroy();
            deliveredCount++;
            score += 500;
            playSfx(880, 'sine', 0.2, 0.1);
            updateUI();
        }
        function p2Update() {
            customers.children.iterate(c => { if(c && c.x < -50) c.destroy(); });
            flyingPizzas.children.iterate(p => { if(p && (p.x > 550 || p.y < -50 || p.y > 550)) p.destroy(); });
        }

        // --- Global Logic ---
        const p1Game = new Phaser.Game(p1Config);
        const p2Game = new Phaser.Game(p2Config);

        function addDough(dist) {
            let p = dist < 20 ? 25 : (dist < 35 ? 15 : 10);
            doughProgress += p;
            if(doughProgress >= 100) {
                doughProgress = 0;
                pizzasReady++;
                playSfx(1200, 'sine', 0.3, 0.1);
            }
            score += p;
            updateUI();
        }

        function updateUI() {
            document.getElementById('dough-bar').style.width = doughProgress + '%';
            document.getElementById('dough-pct').innerText = Math.floor(doughProgress) + '%';
            document.getElementById('pizza-ready-count').innerText = pizzasReady;
            document.getElementById('delivered-count').innerText = deliveredCount;
            document.getElementById('score-val').innerText = score;
        }

        function startPizzaHero() {
            document.getElementById('overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('overlay').style.display = 'none';
                isPlaying = true;
                if (audioCtx.state === 'suspended') audioCtx.resume();
                startTimer();
            }, 800);
        }

        function startTimer() {
            const t = setInterval(() => {
                if(!isPlaying) { clearInterval(t); return; }
                timeLeft--;
                document.getElementById('timer-val').innerText = timeLeft + 's';
                if(timeLeft <= 0) endGame();
            }, 1000);
        }

        function endGame() {
            isPlaying = false;
            const overlay = document.getElementById('overlay');
            const content = document.getElementById('overlay-content');
            content.innerHTML = `
                <div class="text-9xl mb-4">üí∞</div>
                <h1 class="pizza-font text-6xl text-yellow-500 mb-2">SHIFT ENDED!</h1>
                <div class="grid grid-cols-2 gap-4 max-w-sm mx-auto my-6 text-left">
                    <div class="text-gray-400">Pizzas Preparadas:</div><div class="font-bold text-blue-400">${deliveredCount + pizzasReady}</div>
                    <div class="text-gray-400">Pizzas Entregadas:</div><div class="font-bold text-green-400">${deliveredCount}</div>
                    <div class="text-gray-400 text-xl">TOTAL SCORE:</div><div class="font-black text-2xl text-yellow-500">${score}</div>
                </div>
                <div class="flex gap-4 justify-center">
                    <button onclick="location.reload()" class="bg-gray-700 hover:bg-white hover:text-black text-white font-black px-8 py-3 rounded-full transition-all">REINTENTAR</button>
                    <button onclick="submitZKProof()" class="bg-blue-600 hover:bg-white hover:text-blue-600 text-white font-black px-8 py-3 rounded-full transition-all shadow-[0_0_20px_#2563eb]">SUBMIT ZK PROOF</button>
                </div>
            `;
            overlay.style.display = 'flex';
            setTimeout(() => overlay.style.opacity = '1', 10);
        }

        function submitZKProof() {
            alert(`üï∂Ô∏è CONSIGLIERE SLICE:\n\nPrueba ZK Generada:\n- Ingredientes procesados OK\n- Producci√≥n validada OK\n- Entregas verificadas OK\n\nStellar Ledger actualizado. ¬°La familia est√° feliz!`);
            location.reload();
        }
    </script>
</body>
</html>
